<!DOCTYPE html>
<html lang="en" >
  <head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>MayGame</title>
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin="anonymous" />
    <link rel="stylesheet" href="css/styles.css" />
    <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
     <!-- Make sure you put this AFTER Leaflet's CSS -->
 <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
 integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
 crossorigin=""></script>
  </head>
    <body style="background-color: #558888; opacity: 90%;">
    <!-- <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script> -->
    <script src="/js/cdn/gun.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script> -->
    <script src="/js/cdn/sea.js"></script>
    <textarea id="message" placeholder="message"></textarea>
    <br>
    <textarea id="topic" placeholder="topic"></textarea>
    <br>
    <input type="text" name="put_to" list="srvrList" class="border-2" id="gun_server" placeholder="Put to">
    <datalist id="srvrList">
      <option value="https://localhost:8765/gun">
    </datalist>
    <br>
    <input type="text" name="keys" list="keyList" class="border-2" id="keys" placeholder="Key">
    <datalist id="keyList">
    </datalist>
    <br>
    <button onclick="submit_()">Submit</button>
    <button  onclick="">Listen</button>
    <p id="on"></p>
    <br>
    <br>
    <br>
    <input type="text" name="enc_alg" list="kdfList" class="border-2" id="kdfs" placeholder="Kustom kdf" value="default sea">
    <datalist id="kdfList">
      <option value="PBKDF2">
      <option value="Argon2">
      <option value="Scrypt">
    </datalist>
    <br>
    <input type="text" name="key_name" placeholder="key description" id="key_desc">
    <button  onclick="add_key()">Add key</button>
    <br>
    <br>
    <input type="text" name="key_name" placeholder="gun server url" id="gun_url">
    <input type="text" name="key_name" placeholder="description" id="gun_desc">
    <button  onclick="add_gun()">Add gun</button>
    <br>
    <button  onclick="notification_allow()">Allow notification</button>
    <button  onclick="notify('just did')">Notify</button>
    <br>
    <textarea id="cache_input" placeholder="cache response"></textarea>
    <button  onclick="cache_put()">Put to cache</button>
    <div id="cache_sandbox"></div>
    <a href="/your_cache.html">Here.</a>
    <button onclick="toggle_cache_sandbox()">Here. </button>
    <br>
    <button  onclick="ble_request()">Request bluetooth</button>
    <br>
    <input type="file" id="fileElem" multiple accept="image/*" style="display:none" onchange="handleFiles(this.files)">
<label for="fileElem">Select some files</label>
    <br>
    <p id="dropbox">Or drop them here.</p>
    <br>
    <div id="preview"></div>
    <br>
    <button onclick="ask_geopos()">Alert position</button>
    <p id="my_coords"></p>
    <br>
    <div id="mapid" style="height: 180px; width: 180px;"> </div>
    <br>
    <input type="checkbox" id="allow_high_accuracy_checkbox">
    <button  onclick="track_me()">Track me</button>
    <button  onclick="show_position()">Show me on the map</button>
    <br>
    <br>
    <br>
    <h1>Todo:</h1>
    <p>Persist keyring and guns</p>
    <p>Create cached page from user's input: - check</p> 
    <p>Put keyring behind the auth</p>
    <p>Wire two random channels</p>
    <p>Gun.on Print object</p>
    <p>Ble webpage pairing</p>
    <p>Unload mem to file, load from (gun state)</p>
    <p>Chose what to sync with what</p>
    <p>Dropboxes for background, everywhere</p>
    <p>Get predictions about the user status</p>
    <p>high accuracy checkbox: not needed - default option</p>
    <p>screen one screen two cache switch share</p>
    <p></p>
<script>
  var dropbox;
  var preview = document.getElementById("preview")
dropbox = document.getElementById("dropbox");
dropbox.addEventListener("dragenter", dragenter, false);
dropbox.addEventListener("dragover", dragover, false);
dropbox.addEventListener("drop", drop, false);
function dragenter(e) {
  e.stopPropagation();
  e.preventDefault();
}

function dragover(e) {
  e.stopPropagation();
  e.preventDefault();
}
function drop(e) {
  e.stopPropagation();
  e.preventDefault();

  var dt = e.dataTransfer;
  var files = dt.files;

  handleFiles(files);
}
function handleFiles(files) {
  for (var i = 0; i < files.length; i++) {
    var file = files[i];

    if (!file.type.startsWith('image/')){ continue }

    var img = document.createElement("img");
    img.classList.add("obj");
    img.file = file;
    preview.appendChild(img); // preview -> div to display it to.

    var reader = new FileReader();
    reader.onload = (function(aImg) { return function(e) { aImg.src = e.target.result; }; })(img);
    reader.readAsDataURL(file);
  }
}
</script>
    <script>
    var keyring = [];
    var guns = [];
    var pfx = "pfx"
    var testWorker = new Worker("./js/workers/schat.js");
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('scsw.js').then(function(registration) {
          // Registration was successful
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, function(err) {
          // registration failed :(
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }
    // <%# var default_storage = Gun() %>
    // <%# var default_storage = Gun({localStorage:false}) %>
    // <%# var default_storage = Gun("http://90.189.214.114:8765/gun"); %>
    // <%# var default_storage = Gun({peers:["https://gundb-multiserver.glitch.me/"+"yang2"], musticast: false, localStorage: false, radisk: false, file: false}); %>
    async function init(){
        // <%# keyring=default_storage.get(pfx).get("keyring").val() %>
        // <%# keyring=JSON.parse(localStorage.getItem("keyring"))
        // guns=JSON.parse(localStorage.getItem("guns"))
        // console.log(guns) %>
        testWorker.postMessage([1,2]);
      // console.log('sent to worker');
    }
    testWorker.onmessage = function(e) {
    //   <%# result.textContent = e.data; %>
      // console.log('got msg from worker'+e.data);
      // console.log('got msg from worker'+e.data);
    }
    init();
    function submit_(){
        let message = document.getElementById("message").value
        let topic = document.getElementById("topic").value
        let url = document.getElementById("gun_server").value
        let text="message: " + message + "\ntopic: " + topic + "\ngun server: " + url
    if(!topic){console.log("topic is empty")}
    if(!message){console.log("message is empty")}
    else{console.log(text)}
    }
    let update_keyring=()=>{
        let keyList = document.getElementById("keyList")
        keyList.innerHTML =""
        keyring.forEach(function(item) {
      let option = document.createElement('option');
      option.value = item.pub;
      option.text = item.description;
      keyList.appendChild(option)})
      localStorage.setItem("keyring",keyring)
    //   <%# default_storage.get(pfx).get("keyring").put(keyring) %>
      };
    let update_gun_list=()=>{
        let srvrList = document.getElementById("srvrList")
        srvrList.innerHTML =""
        guns.forEach(function(item) {
      let option = document.createElement('option');
      option.value = item.url;
      option.text = item.description;
      srvrList.appendChild(option)})
      localStorage.setItem("guns",guns)
      };
        update_gun_list();
        update_keyring();
        // <%# var gun=Gun(); %>
        var SEA = Gun.SEA;
        async function add_key(){
            var flag=true;
            let description = document.getElementById("key_desc").value;
            if(!description){alert("description should not be empty");flag=false}
            let key=await SEA.pair()
            console.log(key.pub)
            console.log(key.priv)
            console.log(key.epub)
            console.log(key.epriv)
                keyring.forEach(function(item) {
                    if(description==item.description){
                    alert("Key with this name already exists!")
                    flag=false;
                    return;}
                    else {}
                })
                if(flag){
            keyring.push({"pub":key.pub, "priv":key.priv, "epub":key.epub, "epriv":key.epriv, "description":description})
            update_keyring();}
        };
        async function add_gun(){
            let url = document.getElementById("gun_url").value;
            let desc = document.getElementById("gun_desc").value;
            var flag=true;
            if(!url){alert("url should not be empty");flag=false;
            return;}
            if(!url_validate(url)){alert("Invalid url");flag=false;return;}
            if(flag){
            guns.push({"url": url, "description":desc})
            update_gun_list();}
        }
        function url_validate(str){
            var pattern = new RegExp('^(https?:\\/\\/)?'+ // protocol
        '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|'+ // domain name
        '((\\d{1,3}\\.){3}\\d{1,3}))'+ // OR ip (v4) address
        '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+ // port and path
        '(\\?[;&a-z\\d%_.~+=-]*)?'+ // query string
        '(\\#[-a-z\\d_]*)?$','i'); // fragment locator
      return !!pattern.test(str);
        }
    </script>
    <script>
      var map_radius = 13;
	var mymap = L.map('mapid').setView([51.505, -0.09], map_radius);
L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
  maxZoom: 18,
  attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
    'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
  id: 'mapbox/streets-v11',
  tileSize: 512,
  zoomOffset: -1
}).addTo(mymap);
function onMapClick(e) {
    alert("You clicked the map at " + e.latlng);
}
mymap.on('click', onMapClick);
var last_coord = undefined;
var circle = undefined;
var marker = undefined;
function show_position(pos){
  console.log("from show_position, last_coord:")
    console.log(last_coord)
  mymap.setView([last_coord.latitude, last_coord.longitude],map_radius)
  mymap.removeLayer(circle)//todo: trycatch
    circle = L.circle([last_coord.latitude, last_coord.longitude], {
    color: 'red',
    fillColor: '#f03',
    fillOpacity: 0.5,
    radius: last_coord.accuracy
}).addTo(mymap);
mymap.removeLayer(marker)
marker=L.marker([last_coord.latitude, last_coord.longitude]).addTo(mymap)
  // let accuracy = crd.accuracy

}
 function ask_geopos(){
  // alert(Geolocation.getCurrentPosition())
  function success(pos) {
    var crd = pos.coords;
    last_coord = crd;
    console.log("from ask geopos, last_coord:")
    console.log(last_coord)
    var text = "Current pos:\nLat:"+crd.latitude+"\nLng:"+crd.longitude+"\n+- " + crd.accuracy +" meters";
  alert(text);
  console.log('Current pos:');
  console.log(`Lat: ${crd.latitude}`);
  console.log(`Long: ${crd.longitude}`);
  console.log(`+- ${crd.accuracy} meters.`);
  document.getElementById("my_coords").innerHTML=text;
};
function error(err) {
  console.warn(`ERROR(${err.code}): ${err.message}`);
};
var options = {
  enableHighAccuracy: true,
  timeout: 5000,
  maximumAge: 0
};

  navigator.geolocation.getCurrentPosition(success, error, options);
 }
    </script>
    <script>
      var cache_toggled=false;
      function toggle_cache_sandbox() {
        var sandbox = document.getElementById("cache_sandbox")
        if(!cache_toggled)
        {
          var iframe = document.createElement('iframe');
          iframe.style.display = "none";
          iframe.src = "/your_cache.html";
          iframe.sandbox="allow-scripts allow-forms"
          sandbox.appendChild(iframe) 
        }
        else sandbox.removeChild(sandbox.firstChild)
        cache_toggled=!cache_toggled;
      }
    </script>
    <script type="text/javascript">
    async function cache_put(){
    //  const cache = await caches.open('cachee');
     /*
     const jsonResponse = new Response(JSON.stringify(data), {
  headers: {
    'content-type': 'application/json'
  }
});
caches.open('json-cache').then(cache => cache.put('/data.json', jsonResponse));
*/
var response_text = document.getElementById("cache_input").value
var response =new Response(response_text, {
  // headers: {
  url: self.location.origin+'/your_cache.html', 
  status: 200,
  headers: {
    'Content-Type': 'text/html'}
})
caches.open('cachee').then(cache => cache.put('/your_cache.html',response))
      // cache.put('/your_cache.html', response );
caches.match('/your_cache.html').then(r => r).then(console.log)
    }
    function notification_allow(){
      if (!("Notification" in window)) {
    alert("This browser does not support desktop notification");
  }

    Notification.requestPermission()//.then(function (permission) {
      // If the user accepts, let's create a notification    }    );
  }
  function notify(text) { new Notification(text)}
  function ble_request(){
      console.log(navigator.bluetooth.referringDevice)

    navigator.bluetooth.getAvailability();
    navigator.bluetooth.requestDevice({
  acceptAllDevices:true,
  optionalServices:[]
})
function ble_then(){
  navigator.bluetooth.getDevices();

}
// navigator.bluetooth.requestDevice({
//   filters: [ {services: [A, B]} ]
// });
  }
  // navigator.bluetooth.onavailabilitychanged
    </script>
    </body>
    </html>